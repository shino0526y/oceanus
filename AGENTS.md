# AGENTS.md

このファイルはAIコーディングエージェント向けのプロジェクトガイドです。

## プロジェクト概要

OceanusはRustで実装されたPACSです。
DICOM画像の受信・保存と、WEBベースの管理機能を提供します。

## アーキテクチャ

### コンポーネント構成

```
oceanus/
├── src/
│   ├── dicom-lib/         # DICOMライブラリ(共有クレート)
│   ├── dicom-server/      # DICOMサーバー
│   ├── web-api/           # REST APIサーバー
│   └── web-ui/            # WEBフロントエンド
├── db/
│   └── init/              # PostgreSQL初期化SQL
├── docker/                # Docker関連設定
└── docker-compose.yml     # 開発環境(DBのみ)
```

### web-api のオニオンアーキテクチャ

```
web-api/src/internal/
├── presentation/    # ハンドラー、ミドルウェア、エラーレスポンス
├── application/     # ユースケース (ビジネスロジックの調整)
├── domain/          # エンティティ、値オブジェクト、リポジトリトレイト、ドメインエラー
└── infrastructure/  # リポジトリ実装 (PostgreSQL、インメモリ)
```

**依存方向**: presentation → application → domain ← infrastructure

## 開発環境

### よく使うコマンド

| コマンド                | 説明                         |
| ----------------------- | ---------------------------- |
| `make up` / `make down` | 開発用DBの起動 / 停止        |
| `make test`             | 全プロジェクトのテスト実行   |
| `make format`           | 全プロジェクトのコード整形   |
| `cd src && make lint`   | 全プロジェクトのリンター実行 |
| `make sqlx-prepare`     | SQLx メタデータの生成        |

## ルール

### 全般

- やりとりは日本語で行うこと
- 作業を完了させる場合やコミットする場合は以下を行うこと
  - ビルドエラーが存在しないことを確認する
  - テストに成功することを確認する
  - フォーマットを行う
- コミットメッセージのフォーマットはConventional Commitsに準拠させること

### Rust

- エラーには`thiserror`クレートを使用すること
- エラーメッセージは以下の構造で記述する

  ```
  {メッセージ} ({キー}={値}, ...): {原因}
  ^^^^^^^     ^^^^^^^^^^^^^^^    ^^^^
  必須         省略可              省略可
  ```

  - コンテキスト情報がある場合は半角スペース+括弧` (...)`で付加する
  - コンテキストの各項目は`キー=値`の形式で、`, `区切りで並べる
  - 文字列の値はダブルクォートで囲う(例: `ユーザーID="001"`)
  - 数値の値はそのまま記述する(例: `バイト数=17`)
  - 原因となるエラーがある場合は`: `で連結する
  - 例:
    - `空値は許容されません`
    - `文字列の長さが16バイトを超えています (文字列="ABCDEFGHIJKLMNOPQ", バイト数=17)`
    - `文字列から日付へのパースに失敗しました (文字列="invalid"): input is out of range`
    - `バイト列をUTF-8として解釈できません: invalid utf-8 sequence`

- ログは`tracing`クレートを使用すること
- モジュールを作成するにあたり`mod.rs`を使用しないこと
